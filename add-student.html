<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Student – Amit Tutoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- <header> -->
    <div id="site-header"></div>
    <script src="header-loader.js"></script>
  <!-- </header> -->

<main class="container">
  <h2>Add a New Student</h2>
  <p>Tell me about your student so I can plan the right support.</p>

  <form id="add-student-form" class="card">
        <div class="field-row">
          <label>Student Name*</label>
          <input type="text" name="student_first_name" id="student-first-name" placeholder="Alex" required 
            pattern="^[A-Za-z][A-Za-z'\- ]*$" 
            title="First name can include letters, apostrophes, dashes, and spaces." />
          <input type="text" name="student_middle_name" id="student-middle-name" placeholder="Middle name (optional)" 
            pattern="^[A-Za-z][A-Za-z'\- ]*$" 
            title="Middle name can include letters, apostrophes, dashes, and spaces." />
          <input type="text" name="student_last_name" id="student-last-name" placeholder="Johnson" required 
            pattern="^[A-Za-z][A-Za-z'\- ]*$" 
            title="Last name can include letters, apostrophes, dashes, and spaces." />
        </div>

    <div class="field-row">
      <label>Birthdate*</label>
      <input type="date" name="birthdate" id="birthdate" min="1990-01-01" max="2030-12-31" title="Student's birthdate" required />
    </div>

    <div class="field-row">
      <label>Pronouns</label>
      <select name="pronouns" id="pronouns" title="Student's pronouns">
        <option value="">Please select your pronouns</option>
        <option value="he/him">He/Him</option>
        <option value="she/her">She/Her</option>
        <option value="they/them">They/Them</option>
        <option value="ze/zir">Ze/Zir</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="field-row">
      <label>Main Subject</label>
      <input type="text" name="subject" id="subject" placeholder="e.g. Math 7, Physics 30, Chemistry 30 IB, Biology 30..." />
    </div>

      <div class="field-row">
        <label>School</label>
        <input type="text" name="school" id="school" placeholder="e.g. Woodbine Elementary, Wisewood High School..." />
    </div>

    <div class="field-row">
        <label>Relationship to You</label>
        <select name="relationship" id="relationship" title="Relationship to you">
            <option value="">Select relationship...</option>
            <option value="dependent">Dependent</option>
            <option value="self">Self (I'm the student)</option>
            <option value="sibling">Sibling</option>
            <option value="friend">Friend</option>
            <option value="other">Other</option>
        </select>
    </div>

    <div class="field-row">
        <label>Additional Notes</label>
        <textarea name="notes" id="notes" rows="4" placeholder="Any additional information about learning style, goals, or challenges..."></textarea>
    </div>

    <div class="flex-buttons">
        <button type="submit" class="btn primary">Add Student</button>
        <button type="button" class="btn tertiary" onclick="window.location.href='dashboard.html'">Cancel</button>
    </div>

    <p id="form-message" class="form-message"></p>
  </form>
</main>

<footer class="site-footer">
  <div class="container">
    <p>
      © <span id="year"></span> Amit Tutoring ·
      <a href="contact.html">Contact me</a>
    </p>
  </div>
  <script src="core.js" defer></script>
</footer>

<!-- Firebase init -->
<script type="module" src="firebase-config.js"></script>

<!-- Add student logic -->
<script type="module">
  const auth = window.firebaseAuth;
  const db = window.firebaseDb;
  const onAuth = window.firebaseOnAuth;
  const addDoc = window.firestoreAddDoc;
  const collection = window.firestoreCollection;
  const serverTimestamp = window.firestoreServerTimestamp;
  const getDocs = window.firestoreGetDocs;
  const query = window.firestoreQuery;
  const where = window.firestoreWhere;
  const doc = window.firestoreDoc;
  const getDoc = window.firestoreGetDoc;
  const updateDoc = window.firestoreUpdateDoc;

  const form = document.getElementById("add-student-form");
  const msg = document.getElementById("form-message");

  let currentUser = null;

  const normalizeStudentName = (value = "") => value
    .trim()
    .toLowerCase()
    .replace(/[\s'-]+/g, ' ')
    .replace(/\s+/g, ' ');

  const buildFullName = (first, middle, last) => [first, middle, last].filter(Boolean).join(' ');

  // Check authentication
  onAuth(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "Adding student...";
    msg.className = "form-message";

    if (!currentUser) {
      msg.textContent = "You must be logged in to add a student.";
      msg.classList.add("error");
      return;
    }

    const firstName = document.getElementById("student-first-name").value.trim();
    const middleName = document.getElementById("student-middle-name").value.trim();
    const lastName = document.getElementById("student-last-name").value.trim() || 'last name';

    if (!firstName || !lastName) {
      msg.textContent = "First and last name are required.";
      msg.classList.add("error");
      return;
    }

    const studentName = buildFullName(firstName, middleName, lastName);

    const studentData = {
      userId: currentUser.uid,
      studentName,
      firstName,
      middleName: middleName || null,
      lastName,
      birthdate: document.getElementById("birthdate").value,
      pronouns: document.getElementById("pronouns").value || null,
      subject: document.getElementById("subject").value.trim() || null,
      school: document.getElementById("school").value.trim() || null,
      relationship: document.getElementById("relationship").value || null,
      notes: document.getElementById("notes").value.trim(),
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    const normalizedFullName = normalizeStudentName(studentData.studentName);
    studentData.normalizedFullName = normalizedFullName;

    try {
      const studentsRef = collection(db, "students");
      const studentQuery = query(studentsRef, where("userId", "==", currentUser.uid));
      const existingStudentsSnapshot = await getDocs(studentQuery);
      let duplicateRecord = null;

      for (const docSnap of existingStudentsSnapshot.docs) {
        const existingData = docSnap.data();
        const existingName = normalizeStudentName(existingData?.studentName || "");
        if (existingName && existingName === normalizedFullName) {
          duplicateRecord = { id: docSnap.id, data: existingData };
          break;
        }
      }

      let firestoreDocId;
      const previousStudentName = duplicateRecord?.data?.studentName || null;
      const isUpdate = Boolean(duplicateRecord);

      if (isUpdate) {
        firestoreDocId = duplicateRecord.id;
        const preservedCreatedAt = duplicateRecord.data?.createdAt || studentData.createdAt;
        const updatePayload = {
          ...studentData,
          createdAt: preservedCreatedAt,
          updatedAt: serverTimestamp()
        };
        await updateDoc(doc(db, "students", firestoreDocId), updatePayload);
      } else {
        const docRef = await addDoc(studentsRef, studentData);
        firestoreDocId = docRef.id;
      }
      
      // Also sync to Google Sheets for desktop app
      try {
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};

        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbxKXmxMroW74nabysGBr4LDFhwkURxaBiDntFVnowpP5PN-Czy6cWYnfO5axE58x5_j/exec';

        if (isUpdate) {
          await fetch(appsScriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              type: 'delete_student',
              studentId: firestoreDocId,
              studentName: previousStudentName || studentData.studentName,
              userId: currentUser.uid
            })
          });
        }

        await fetch(appsScriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'add_student',
            studentId: firestoreDocId, // Send the Firestore document ID
            userId: currentUser.uid,
            studentName: studentData.studentName,
            yearOfBirth: studentData.birthdate ? new Date(studentData.birthdate).getFullYear().toString() : '',
            subject: studentData.subject || '',
            school: studentData.school || '',
            relationship: studentData.relationship || '',
            userEmail: userData.email || currentUser.email,
            userPhone: userData.phone || '',
            notes: studentData.notes || ''
          })
        });
        console.log('Student synced to Google Sheets');
      } catch (sheetError) {
        console.error('Failed to sync to Google Sheets:', sheetError);
        // Don't fail the operation if sheets sync fails
      }
      
      msg.textContent = isUpdate ? "Student updated successfully!" : "Student added successfully!";
      msg.classList.add("ok");
      
      // Redirect to dashboard after 1.5 seconds
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);

    } catch (err) {
      console.error("Error adding student:", err);
      msg.textContent = "Failed to add student. Please try again.";
      msg.classList.add("error");
    }
  });
</script>
</body>
</html>
