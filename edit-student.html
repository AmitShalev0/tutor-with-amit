<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Student – Amit Tutoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="site-header"></div>
<script src="header-loader.js"></script>

<main class="container">
  <h2>Edit Student Profile</h2>
  <p>Update student information.</p>

  <form id="edit-student-form" class="card">
    <div class="field-row">
      <label>Student's Full Name*</label>
      <input type="text" name="student_name" id="student-name" placeholder="Alex Johnson" required 
            pattern="^[a-zA-Z][a-zA-Z'-]* [a-zA-Z][a-zA-Z'-]*$" 
            title="Student name must be two words (first and last name), each with only letters, apostrophes, or dashes." />
    </div>

    <div class="field-row">
      <label>Birthdate</label>
      <input type="date" name="birthdate" id="birthdate" min="1900-01-01" max="2030-12-31" title="Student's birthdate" />
    </div>

    <div class="field-row">
      <label>Pronouns</label>
      <select name="pronouns" id="pronouns" title="Student's pronouns">
        <option value="">Please select your pronouns</option>
        <option value="he/him">He/Him</option>
        <option value="she/her">She/Her</option>
        <option value="they/them">They/Them</option>
        <option value="ze/zir">Ze/Zir</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="field-row">
      <label>Main Subject</label>
      <input type="text" name="subject" id="subject" placeholder="e.g. Math 7, Physics 30, Chemistry 30 IB, Biology 30..." />
    </div>

    <div class="field-row">
      <label>School</label>
      <input type="text" name="school" id="school" placeholder="e.g. Woodbine Elementary, Wisewood High School..." />
    </div>

    <div class="field-row">
      <label>Relationship to You</label>
      <select name="relationship" id="relationship" title="Relationship to you">
        <option value="">Select relationship...</option>
        <option value="dependent">Dependent</option>
        <option value="self">Self (I'm the student)</option>
        <option value="sibling">Sibling</option>
        <option value="friend">Friend</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="field-row">
      <label>Additional Notes</label>
      <textarea name="notes" id="notes" rows="4" placeholder="Any additional information about learning style, goals, or challenges..."></textarea>
    </div>

    <div class="flex-buttons">
      <button type="submit" class="btn primary">Save Changes</button>
      <button type="button" class="btn tertiary" onclick="window.location.href='dashboard.html'">Cancel</button>
    </div>

    <p id="form-message" class="form-message"></p>
  </form>
</main>

<footer class="site-footer">
  <div class="container">
    <p>
      © <span id="year"></span> Amit Tutoring ·
      <a href="contact.html">Contact me</a>
    </p>
  </div>
  <script src="main.js"></script>
</footer>

<!-- Firebase init -->
<script type="module" src="firebase-config.js"></script>

<!-- Edit student logic -->
<script type="module">
  const auth = window.firebaseAuth;
  const db = window.firebaseDb;
  const onAuth = window.firebaseOnAuth;
  const getDoc = window.firestoreGetDoc;
  const updateDoc = window.firestoreUpdateDoc;
  const doc = window.firestoreDoc;
  const serverTimestamp = window.firestoreServerTimestamp;

  const form = document.getElementById("edit-student-form");
  const msg = document.getElementById("form-message");

  let currentUser = null;
  let studentId = null;

  // Get student ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  studentId = urlParams.get('id');

  if (!studentId) {
    alert("No student ID provided");
    window.location.href = "dashboard.html";
  }

  // Check authentication
  onAuth(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
    
    // Load student data
    await loadStudentData();
  });

  async function loadStudentData() {
    try {
      msg.textContent = "Loading student data...";
      
      const studentDoc = await getDoc(doc(db, "students", studentId));
      
      if (!studentDoc.exists()) {
        alert("Student not found");
        window.location.href = "dashboard.html";
        return;
      }

      const student = studentDoc.data();

      // Verify ownership
      if (student.userId !== currentUser.uid) {
        alert("You don't have permission to edit this student");
        window.location.href = "dashboard.html";
        return;
      }

      // Fill form with existing data
      document.getElementById("student-name").value = student.studentName || "";
      document.getElementById("birthdate").value = student.birthdate || "";
      document.getElementById("pronouns").value = student.pronouns || "";
      document.getElementById("subject").value = student.subject || "";
      document.getElementById("school").value = student.school || "";
      document.getElementById("relationship").value = student.relationship || "";
      document.getElementById("notes").value = student.notes || "";

      msg.textContent = "";
    } catch (err) {
      console.error("Error loading student:", err);
      msg.textContent = "Failed to load student data.";
      msg.classList.add("error");
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "Saving changes...";
    msg.className = "form-message";

    if (!currentUser) {
      msg.textContent = "You must be logged in to edit a student.";
      msg.classList.add("error");
      return;
    }

    const updatedData = {
      studentName: document.getElementById("student-name").value.trim(),
      birthdate: document.getElementById("birthdate").value,
      pronouns: document.getElementById("pronouns").value || null,
      subject: document.getElementById("subject").value.trim() || null,
      school: document.getElementById("school").value.trim() || null,
      relationship: document.getElementById("relationship").value || null,
      notes: document.getElementById("notes").value.trim(),
      updatedAt: serverTimestamp()
    };

    try {
      await updateDoc(doc(db, "students", studentId), updatedData);
      
      msg.textContent = "Student updated successfully!";
      msg.classList.add("ok");
      
      // Redirect to dashboard after 1.5 seconds
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);

    } catch (err) {
      console.error("Error updating student:", err);
      msg.textContent = "Failed to update student. Please try again.";
      msg.classList.add("error");
    }
  });
</script>
</body>
</html>
