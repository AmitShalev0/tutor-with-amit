<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Student – Amit Tutoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .link-button {
      background: none;
      border: none;
      color: var(--primary-color);
      text-decoration: underline;
      padding: 0;
      cursor: pointer;
      font: inherit;
    }
  </style>
</head>
<body>
<div id="site-header"></div>
<script src="header-loader.js"></script>

<main class="container">
  <h2>Edit Student Profile</h2>
  <p>Update student information.</p>

  <form id="edit-student-form" class="card">
        <div class="field-row">
      <label>Student Name*</label>
      <input type="text" name="student_first_name" id="student-first-name" placeholder="Alex" required 
        pattern="^[A-Za-z][A-Za-z'\- ]*$" 
        title="First name can include letters, apostrophes, dashes, and spaces." />
      <input type="text" name="student_middle_name" id="student-middle-name" placeholder="Middle name (optional)" 
        pattern="^[A-Za-z][A-Za-z'\- ]*$" 
        title="Middle name can include letters, apostrophes, dashes, and spaces." />
      <input type="text" name="student_last_name" id="student-last-name" placeholder="Johnson" required 
        pattern="^[A-Za-z][A-Za-z'\- ]*$" 
        title="Last name can include letters, apostrophes, dashes, and spaces." />
        </div>

    <div class="field-row">
      <label>Birthdate</label>
      <input type="date" name="birthdate" id="birthdate" min="1900-01-01" max="2030-12-31" title="Student's birthdate" />
    </div>

    <div class="field-row">
      <label>Pronouns</label>
      <select name="pronouns" id="pronouns" title="Student's pronouns">
        <option value="">Please select your pronouns</option>
        <option value="he/him">He/Him</option>
        <option value="she/her">She/Her</option>
        <option value="they/them">They/Them</option>
        <option value="ze/zir">Ze/Zir</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="field-row">
      <label>Grade*</label>
      <select name="grade" id="grade" required title="Select the student's grade">
        <option value="">Select grade...</option>
        <option value="k-6">K-6</option>
        <option value="7-9">7-9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="university">University</option>
        <option value="college">College</option>
        <option value="community">Community Learning</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="field-row">
      <label>Subject*</label>
      <select name="subject" id="subject" required disabled title="Select the student's subject">
        <option value="">Select grade first...</option>
      </select>
      <p class="help-text">Grade and subject are required to book sessions. <button type="button" id="request-course-btn" class="link-button">Don't see your course? Add it here!</button></p>
    </div>

    <div class="field-row">
      <label>School</label>
      <input type="text" name="school" id="school" placeholder="e.g. Woodbine Elementary, Wisewood High School..." />
    </div>

    <div class="field-row">
      <label>Relationship to You</label>
      <select name="relationship" id="relationship" title="Relationship to you">
        <option value="">Select relationship...</option>
        <option value="dependent">Dependent</option>
        <option value="self">Self (I'm the student)</option>
        <option value="sibling">Sibling</option>
        <option value="friend">Friend</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="field-row">
      <label>Additional Notes</label>
      <textarea name="notes" id="notes" rows="4" placeholder="Any additional information about learning style, goals, or challenges..."></textarea>
    </div>

    <div class="flex-buttons">
      <button type="submit" class="btn primary">Save Changes</button>
      <button type="button" class="btn tertiary" onclick="window.location.href='dashboard.html'">Cancel</button>
    </div>

    <p id="form-message" class="form-message"></p>
  </form>
</main>

<footer class="site-footer">
  <div class="container">
    <p>
      © <span id="year"></span> Amit Tutoring ·
      <a href="contact.html">Contact me</a>
    </p>
  </div>
  <script src="admin.js" defer></script>
</footer>

<!-- Firebase init -->
<script type="module" src="firebase-config.js"></script>

<!-- Edit student logic -->
<script type="module">
  import { CANONICAL_COURSES, buildCourseIndex, sortCourses, findCourseByLabel } from './course-catalog.js';

  const auth = window.firebaseAuth;
  const db = window.firebaseDb;
  const onAuth = window.firebaseOnAuth;
  const getDoc = window.firestoreGetDoc;
  const getDocs = window.firestoreGetDocs;
  const updateDoc = window.firestoreUpdateDoc;
  const addDoc = window.firestoreAddDoc;
  const collection = window.firestoreCollection;
  const doc = window.firestoreDoc;
  const serverTimestamp = window.firestoreServerTimestamp;

  const COURSES_COLLECTION = 'courses';
  const COURSE_REQUESTS_COLLECTION = 'courseRequests';

  const form = document.getElementById("edit-student-form");
  const msg = document.getElementById("form-message");
  const gradeSelect = document.getElementById('grade');
  const subjectSelect = document.getElementById('subject');
  const requestCourseBtn = document.getElementById('request-course-btn');

  let currentUser = null;
  let studentId = null;
  let canonicalCourses = [];
  let courseIndex = null;
  let currentCourseId = null;
  let subjectOptionsByGrade = null;
  let coursesPromise = null;

  // Get student ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  studentId = urlParams.get('id');

  if (!studentId) {
    alert("No student ID provided");
    window.location.href = "dashboard.html";
  }

  function splitNameParts(name = '') {
    const parts = (name || '').trim().split(/\s+/).filter(Boolean);
    if (parts.length === 0) return { first: '', middle: '', last: 'last name' };
    if (parts.length === 1) return { first: parts[0], middle: '', last: 'last name' };
    if (parts.length === 2) return { first: parts[0], middle: '', last: parts[1] };
    return { first: parts[0], middle: parts.slice(1, -1).join(' '), last: parts[parts.length - 1] };
  }

  function buildFullName(first, middle, last) {
    return [first, middle, last].filter(Boolean).join(' ');
  }

  function normalizeStudentName(value = '') {
    return value.trim().toLowerCase().replace(/[\s'-]+/g, ' ').replace(/\s+/g, ' ');
  }

  function subjectGroupToLabel(group) {
    const key = (group || '').toLowerCase();
    const map = {
      math: 'Math',
      english: 'English',
      ela: 'English',
      social: 'Social',
      science: 'Science',
      french: 'French',
      biology: 'Biology',
      chemistry: 'Chemistry',
      physics: 'Physics'
    };
    if (map[key]) return map[key];
    return key ? key.charAt(0).toUpperCase() + key.slice(1) : '';
  }

  function mapGradeValueToCeiling(gradeValue) {
    switch ((gradeValue || '').toLowerCase()) {
      case 'k-6': return 6;
      case '7-9': return 9;
      case '10': return 10;
      case '11': return 11;
      case '12': return 12;
      default: return null;
    }
  }

  function getDefaultCourses() {
    return sortCourses(CANONICAL_COURSES.map((c) => ({ ...c })));
  }

  function setCourses(list) {
    canonicalCourses = sortCourses(list || []);
    courseIndex = buildCourseIndex(canonicalCourses);
  }

  async function loadCoursesFromFirestore() {
    if (!db) {
      setCourses(getDefaultCourses());
      return canonicalCourses;
    }
    try {
      const querySnap = await getDocs(collection(db, COURSES_COLLECTION));
      const rows = querySnap.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
      if (rows.length) {
        setCourses(rows);
        return canonicalCourses;
      }
    } catch (error) {
      console.warn('Courses fetch failed, using defaults', error);
    }

    setCourses(getDefaultCourses());
    return canonicalCourses;
  }

  function getCourseBySubjectAndLevel(subjectGroup, gradeCeiling) {
    const candidates = canonicalCourses
      .filter((c) => c.subjectGroup === subjectGroup)
      .sort((a, b) => (a.gradeCeiling || 0) - (b.gradeCeiling || 0));
    if (!candidates.length) return null;
    if (gradeCeiling) {
      const exact = candidates.find((c) => c.gradeCeiling === gradeCeiling);
      if (exact) return exact;
      const lower = candidates.filter((c) => c.gradeCeiling <= gradeCeiling);
      if (lower.length) return lower[lower.length - 1];
    }
    return candidates[candidates.length - 1];
  }

  function inferSubjectGroupFromText(value) {
    if (!value) return null;
    const text = value.toString().trim().toLowerCase();
    if (!text) return null;

    if (text.includes('chem')) return 'chemistry';
    if (text.includes('bio')) return 'biology';
    if (text.includes('phys')) return 'physics';
    if (text.includes('math')) return 'math';
    if (text.includes('english') || text.includes('ela')) return 'english';
    if (text.includes('social')) return 'social';
    if (text.includes('french')) return 'french';
    if (text.includes('science')) return 'science';
    return null;
  }

  function inferCourseFromText(value) {
    if (!value) return null;
    const text = value.toString().trim().toLowerCase();
    if (!text) return null;

    const subjectGroup = inferSubjectGroupFromText(text);

    let gradeCeiling = null;
    if (/gr\s*12|grade\s*12|\b12\b/.test(text)) gradeCeiling = 12;
    else if (/gr\s*11|grade\s*11|\b11\b/.test(text)) gradeCeiling = 11;
    else if (/gr\s*10|grade\s*10|\b10\b/.test(text)) gradeCeiling = 10;
    else if (/jr|junior|grade\s*[7-9]|\b7\b|\b8\b|\b9\b/.test(text)) gradeCeiling = 9;
    else if (/elem|elementary|k-6|\bk\b|kindergarten|\b[1-6]\b/.test(text)) gradeCeiling = 6;

    if (!subjectGroup) return null;
    return getCourseBySubjectAndLevel(subjectGroup, gradeCeiling || undefined);
  }

  function findCourseFromInput(value) {
    if (!value) return null;
    const direct = courseIndex ? findCourseByLabel(value, courseIndex) : null;
    if (direct) return direct;
    return inferCourseFromText(value);
  }

  function pickCourseFromGradeAndSubject(gradeValue, subjectLabel) {
    const gradeCeiling = mapGradeValueToCeiling(gradeValue);
    const subjectGroup = inferSubjectGroupFromText(subjectLabel);

    if (courseIndex && subjectLabel) {
      const direct = findCourseByLabel(subjectLabel, courseIndex);
      if (direct) return direct;
    }

    if (subjectGroup && gradeCeiling) {
      const match = getCourseBySubjectAndLevel(subjectGroup, gradeCeiling);
      if (match) return match;
    }

    if (subjectGroup) {
      const fallback = canonicalCourses.find((c) => c.subjectGroup === subjectGroup);
      if (fallback) return fallback;
    }

    return findCourseFromInput(subjectLabel);
  }

  function buildSubjectOptions() {
    const baseSubjects = ["Math", "English", "Social", "Science", "French", "Physics", "Biology", "Chemistry"];
    subjectOptionsByGrade = {
      "k-6": baseSubjects,
      "7-9": baseSubjects,
      "10": baseSubjects,
      "11": baseSubjects,
      "12": baseSubjects,
      "university": baseSubjects,
      "college": baseSubjects,
      "community": baseSubjects,
      "other": baseSubjects
    };
  }

  function gradeKeyFromCourse(course) {
    if (!course) return "";
    const ceiling = Number(course.gradeCeiling);
    if (!Number.isFinite(ceiling)) return "";
    if (ceiling <= 6) return "k-6";
    if (ceiling <= 9) return "7-9";
    if (ceiling === 10) return "10";
    if (ceiling === 11) return "11";
    return "12";
  }

  function setSubjectOptions(gradeKey, preselectValue = null) {
    if (!subjectSelect) return;
    subjectSelect.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = gradeKey ? 'Select subject...' : 'Select grade first...';
    subjectSelect.appendChild(placeholder);

    const options = subjectOptionsByGrade?.[gradeKey] || [];
    subjectSelect.disabled = !options.length;

    options.forEach((label) => {
      const opt = document.createElement('option');
      opt.value = label;
      opt.textContent = label;
      subjectSelect.appendChild(opt);
    });

    if (preselectValue) {
      subjectSelect.value = preselectValue;
    }
  }

  function handleCourseInputChange() {
    const value = subjectSelect ? subjectSelect.value : '';
    const gradeValue = gradeSelect ? gradeSelect.value : '';
    const match = pickCourseFromGradeAndSubject(gradeValue, value);
    currentCourseId = match ? match.id : null;
  }

  async function submitCourseRequest() {
    const name = prompt('What is the exact course name?');
    if (!name) return;
    const school = prompt('Which school do you attend?');
    if (!school) return;

    try {
      await addDoc(collection(db, COURSE_REQUESTS_COLLECTION), {
        name: name.trim(),
        school: school.trim(),
        userId: currentUser?.uid || null,
        userEmail: currentUser?.email || null,
        status: 'pending',
        createdAt: serverTimestamp()
      });
      msg.textContent = 'Thanks! Your course request was sent for review.';
      msg.classList.remove('error');
      msg.classList.add('ok');
    } catch (error) {
      console.error('Failed to submit course request', error);
      msg.textContent = 'Unable to submit course request. Please try again later.';
      msg.classList.add('error');
    }
  }

  if (gradeSelect) {
    gradeSelect.addEventListener('change', () => {
      setSubjectOptions(gradeSelect.value || '');
      subjectSelect.value = '';
      currentCourseId = null;
    });
  }

  if (subjectSelect) {
    subjectSelect.addEventListener('change', handleCourseInputChange);
    subjectSelect.addEventListener('input', () => {
      currentCourseId = null;
    });
  }

  if (requestCourseBtn) {
    requestCourseBtn.addEventListener('click', submitCourseRequest);
  }

  // Check authentication
  onAuth(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;

    buildSubjectOptions();
    coursesPromise = loadCoursesFromFirestore();
    
    // Load student data
    await loadStudentData();
  });

  async function loadStudentData() {
    try {
      msg.textContent = "Loading student data...";
      
      const studentDoc = await getDoc(doc(db, "students", studentId));
      
      if (!studentDoc.exists()) {
        alert("Student not found");
        window.location.href = "dashboard.html";
        return;
      }

      const student = studentDoc.data();

      await (coursesPromise || loadCoursesFromFirestore());
      const gradeKey = student.subjectGrade || gradeKeyFromCourse(findCourseFromInput(student.subject || student.subjectId));
      const matchedCourse = pickCourseFromGradeAndSubject(gradeKey, student.subject || student.subjectId);
      currentCourseId = matchedCourse ? matchedCourse.id : null;

      // Verify ownership
      if (student.userId !== currentUser.uid) {
        alert("You don't have permission to edit this student");
        window.location.href = "dashboard.html";
        return;
      }

      // Fill form with existing data
      const nameParts = splitNameParts(student.studentName || "");
      document.getElementById("student-first-name").value = nameParts.first;
      document.getElementById("student-middle-name").value = nameParts.middle;
      document.getElementById("student-last-name").value = nameParts.last;
      document.getElementById("birthdate").value = student.birthdate || "";
      document.getElementById("pronouns").value = student.pronouns || "";
      document.getElementById("school").value = student.school || "";
      document.getElementById("relationship").value = student.relationship || "";
      document.getElementById("notes").value = student.notes || "";

      if (gradeSelect) {
        gradeSelect.value = gradeKey || "";
      }
      const subjectDisplay = matchedCourse
        ? subjectGroupToLabel(matchedCourse.subjectGroup)
        : subjectGroupToLabel(inferSubjectGroupFromText(student.subject || "")) || (student.subject || "");
      setSubjectOptions(gradeKey || "", subjectDisplay);
      handleCourseInputChange();

      msg.textContent = "";
    } catch (err) {
      console.error("Error loading student:", err);
      msg.textContent = "Failed to load student data.";
      msg.classList.add("error");
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "Saving changes...";
    msg.className = "form-message";

    if (!currentUser) {
      msg.textContent = "You must be logged in to edit a student.";
      msg.classList.add("error");
      return;
    }

    const selectedGrade = gradeSelect?.value || "";
    const selectedSubject = subjectSelect?.value.trim() || "";

    if (!selectedGrade || !selectedSubject) {
      msg.textContent = "Please select both grade and subject.";
      msg.classList.add("error");
      return;
    }

    const matchedCourse = pickCourseFromGradeAndSubject(selectedGrade, selectedSubject);

    const firstName = document.getElementById("student-first-name").value.trim();
    const middleName = document.getElementById("student-middle-name").value.trim();
    const lastName = document.getElementById("student-last-name").value.trim() || 'last name';

    if (!firstName || !lastName) {
      msg.textContent = "First and last name are required.";
      msg.classList.add("error");
      return;
    }

    const studentName = buildFullName(firstName, middleName, lastName);

    const updatedData = {
      studentName,
      firstName,
      middleName: middleName || null,
      lastName,
      normalizedFullName: normalizeStudentName(studentName),
      birthdate: document.getElementById("birthdate").value,
      pronouns: document.getElementById("pronouns").value || null,
      subjectGrade: selectedGrade,
      subject: matchedCourse ? matchedCourse.label : selectedSubject,
      subjectId: matchedCourse ? matchedCourse.id : null,
      school: document.getElementById("school").value.trim() || null,
      relationship: document.getElementById("relationship").value || null,
      notes: document.getElementById("notes").value.trim(),
      updatedAt: serverTimestamp()
    };

    try {
      await updateDoc(doc(db, "students", studentId), updatedData);
      
      msg.textContent = "Student updated successfully!";
      msg.classList.add("ok");
      
      // Redirect to dashboard after 1.5 seconds
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);

    } catch (err) {
      console.error("Error updating student:", err);
      msg.textContent = "Failed to update student. Please try again.";
      msg.classList.add("error");
    }
  });
</script>
</body>
</html>
