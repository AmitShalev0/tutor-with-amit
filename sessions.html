<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Sessions ‚Äì Amit Tutoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .sessions-container {
      display: grid;
      gap: 2rem;
      margin-top: 1.5rem;
    }
    .session-section h3 {
      margin-bottom: 1rem;
      color: var(--accent);
    }
    .sessions-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .sessions-table th,
    .sessions-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .sessions-table th {
      background: var(--surface-alt);
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .sessions-table tr:last-child td {
      border-bottom: none;
    }
    .sessions-table tr:hover {
      background: var(--surface-alt);
    }
    .session-actions {
      display: flex;
      gap: 0.5rem;
    }
    .session-actions button {
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
    }
    .session-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    .status-past {
      background: #e5e7eb;
      color: #374151;
    }
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .status-approved {
      background: #d1fae5;
      color: #065f46;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
    }
    .notes-preview {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <h1 class="logo"><a href="index.html">Amit Tutoring</a></h1>

    <nav>
      <a href="dashboard.html">My Dashboard</a>
      <a href="sessions.html" class="active">My Sessions</a>
    </nav>

    <div class="header-right">
      <label class="theme-switch" title="Toggle light/dark mode">
        <input type="checkbox" id="theme-toggle" aria-label="Toggle theme">
        <span class="switch-slider"></span>
      </label>
      <div id="current-time" class="current-time"></div>
    </div>
  </div>
</header>

<main class="container">
  <div class="flex-between mb-1">
    <div>
      <h2 class="m-0">My Sessions</h2>
      <p class="mt-0-5rem">View all your past and upcoming tutoring sessions.</p>
    </div>
    <button class="btn primary" onclick="window.location.href='book-session.html'">Book Session</button>
  </div>

  <div class="sessions-container">
    <!-- Upcoming Sessions -->
    <div class="session-section">
      <h3>Upcoming Sessions</h3>
      <div id="upcoming-sessions-content">
        <p class="loading-text">Loading upcoming sessions...</p>
      </div>
    </div>

    <!-- Pending Sessions -->
    <div class="session-section">
      <h3>Pending Sessions</h3>
      <div id="pending-sessions-content">
        <p class="loading-text">Loading pending sessions...</p>
      </div>
    </div>

    <!-- Past Sessions -->
    <div class="session-section">
      <h3>Past Sessions</h3>
      <div id="past-sessions-content">
        <p class="loading-text">Loading past sessions...</p>
      </div>
    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <p>
      ¬© <span id="year"></span> Amit Tutoring ¬∑
      <a href="contact.html">Contact me</a>
    </p>
  </div>
  <script src="main.js"></script>
</footer>

<!-- Firebase init -->
<script type="module" src="firebase.js"></script>

<!-- Sessions logic -->
<script type="module">
  // Wait for firebase.js to fully load
  function waitForFirebase() {
    return new Promise((resolve) => {
      if (window.firebaseAuth && window.firebaseDb) {
        resolve();
      } else {
        setTimeout(() => waitForFirebase().then(resolve), 100);
      }
    });
  }

  waitForFirebase().then(() => {
    // Use window globals that are already set up
    const auth = window.firebaseAuth;
    const db = window.firebaseDb;
    const onAuthStateChanged = window.firebaseOnAuth;
    const collection = window.firestoreCollection;
    const query = window.firestoreQuery;
    const where = window.firestoreWhere;
    const getDocs = window.firestoreGetDocs;

    let currentUser = null;
    let allSessions = [];

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadSessions();
    });

  async function loadSessions() {
    try {
      console.log("Loading sessions for user:", currentUser.uid);
      
      // Fetch user's bookings from Firestore
      // Use "bookings" collection which contains pending requests
      const bookingsQuery = query(
        collection(db, "bookings"),
        where("userId", "==", currentUser.uid)
      );
      
      const querySnapshot = await getDocs(bookingsQuery);
      allSessions = [];
      
      console.log("Query snapshot size:", querySnapshot.size);
      
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        console.log("Booking data:", doc.id, data);
        allSessions.push({
          id: doc.id,
          ...data,
          // Keep the raw value; only convert Firestore Timestamps
          sessionDate: data.sessionDate && data.sessionDate.toDate
            ? data.sessionDate.toDate()
            : data.sessionDate
        });
      });

      console.log("Total sessions loaded:", allSessions.length);

      // Sort by date (earliest first for better upcoming view)
      allSessions.sort((a, b) => a.sessionDate - b.sessionDate);

      displaySessions();
    } catch (err) {
      console.error("Error loading sessions:", err);
      
      // Show error message to user
      document.getElementById("upcoming-sessions-content").innerHTML = 
        `<div class="empty-state" style="color: #dc3545;">Error loading sessions: ${err.message}</div>`;
      document.getElementById("pending-sessions-content").innerHTML = 
        `<div class="empty-state">Unable to load data</div>`;
      document.getElementById("past-sessions-content").innerHTML = 
        `<div class="empty-state">Unable to load data</div>`;
    }
  }


  function getSessionDateForCompare(raw) {
    if (!raw) return null;

    // Firestore Timestamp
    if (raw.toDate) {
      const d = raw.toDate();
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // Already a Date object
    if (raw instanceof Date) {
      const d = new Date(raw);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // "YYYY-MM-DD" string ‚Äì treat as local date
    if (typeof raw === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(raw)) {
      const [y, m, d] = raw.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    // Fallback
    const d = new Date(raw);
    d.setHours(0, 0, 0, 0);
    return d;
  }


  function displaySessions() {
    const now = new Date();
    now.setHours(0, 0, 0, 0); // Set to start of today for comparison
    
    console.log("Displaying sessions. Total:", allSessions.length);
    
    const pending = allSessions.filter(s => (s.status || 'pending').toLowerCase() === 'pending');
    const upcoming = allSessions.filter(s => {
      const sessionDate = getSessionDateForCompare(s.sessionDate);
      if (!sessionDate) return false;
      const status = (s.status || '').toLowerCase();
      return sessionDate >= now && status !== 'pending';
      // Include approved sessions OR sessions synced from TutorDesk (which have status "approved")
      return sessionDate >= now && status !== 'pending';
    });
    const past = allSessions.filter(s => {
    const sessionDate = getSessionDateForCompare(s.sessionDate);
    if (!sessionDate) return false;
    return sessionDate < now;
    });

    console.log("Categorized - Upcoming:", upcoming.length, "Pending:", pending.length, "Past:", past.length);

    // Display upcoming sessions
    const upcomingContent = document.getElementById("upcoming-sessions-content");
    if (upcoming.length === 0) {
      upcomingContent.innerHTML = '<div class="empty-state">No upcoming sessions scheduled. <a href="book-session.html">Book a session</a> to get started!</div>';
    } else {
      upcomingContent.innerHTML = `
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Session Date</th>
              <th>Start & End Time</th>
              <th>Student Name</th>
              <th>Comments / Questions</th>
            </tr>
          </thead>
          <tbody>
            ${upcoming.map(session => renderUnifiedSessionRow(session)).join('')}
          </tbody>
        </table>
      `;
    }

    // Display pending sessions
    const pendingContent = document.getElementById("pending-sessions-content");
    if (pending.length === 0) {
      pendingContent.innerHTML = '<div class="empty-state">No pending sessions.</div>';
    } else {
      pendingContent.innerHTML = `
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Session Date</th>
              <th>Start & End Time</th>
              <th>Student Name</th>
              <th>Comments / Questions</th>
            </tr>
          </thead>
          <tbody>
            ${pending.map(session => renderUnifiedSessionRow(session)).join('')}
          </tbody>
        </table>
      `;
    }

    // Display past sessions
    const pastContent = document.getElementById("past-sessions-content");
    if (past.length === 0) {
      pastContent.innerHTML = '<div class="empty-state">No past sessions yet.</div>';
    } else {
      pastContent.innerHTML = `
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Session Date</th>
              <th>Start & End Time</th>
              <th>Student Name</th>
              <th>Comments / Questions</th>
            </tr>
          </thead>
          <tbody>
            ${past.map(session => renderUnifiedSessionRow(session)).join('')}
          </tbody>
        </table>
      `;
    }
  }

  function formatSessionDate(value) {
    if (!value) return '-';

    if (value.toDate) {
      return value.toDate().toLocaleDateString();
    }
    if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
      const d = new Date(value + 'T00:00:00');
      return d.toLocaleDateString();
    }
    return new Date(value).toLocaleDateString();
  }


  function renderUnifiedSessionRow(session) {
    const dateStr = formatSessionDate(session.sessionDate);
    // const sessionDate = new Date(session.sessionDate);
    // const dateStr = formatSessionDate(sessionDate);
    // const dateStr = sessionDate.toLocaleDateString('en-US', { 
    //   weekday: 'short', 
    //   year: 'numeric', 
    //   month: 'short', 
    //   day: 'numeric' 
    // });
    const timeStr = session.startTime && session.endTime 
      ? `${session.startTime} - ${session.endTime}` 
      : session.startTime || 'TBD';
    const students = session.studentName || session.studentNames || session.students || 'N/A';
    const summary = session.sessionSummary || session.comments || session.notes || session.additionalComments || '';

    // Show session summary if it exists
    const summaryHtml = summary ? `
      <div style="margin-top: 8px; padding: 12px; background: rgba(79, 157, 255, 0.1); border-left: 3px solid #4f9dff; border-radius: 4px;">
        <div style="font-weight: 600; color: #4f9dff; font-size: 0.85rem; margin-bottom: 6px;">üìù Session Notes from Tutor:</div>
        <div style="white-space: pre-wrap; font-size: 0.9rem; line-height: 1.5; color: #f5f5f7;">${summary}</div>
      </div>
    ` : '<div style="color: #b0b0b5; font-style: italic;">No notes yet</div>';

    return `
      <tr>
        <td>${dateStr}</td>
        <td>${timeStr}</td>
        <td>${students}</td>
        <td>${summaryHtml}</td>
      </tr>
    `;
  }

  function editSession(session) {
    // Redirect to edit booking page
    window.location.href = `edit-booking.html?id=${session.id}`;
  }

  async function removeSession(session) {
    const dateStr = formatSessionDate(session.sessionDate);

    // const sessionDate = new Date(session.sessionDate);
    // const dateStr = formatSessionDate(sessionDate);
    // const dateStr = sessionDate.toLocaleDateString('en-US', { 
    //   weekday: 'long', 
    //   year: 'numeric', 
    //   month: 'long', 
    //   day: 'numeric' 
    // });
    
    if (!confirm(`Are you sure you want to cancel the session on ${dateStr} at ${session.startTime}?\n\nThis action cannot be undone.`)) {
      return;
    }

    try {
      const deleteDoc = window.firestoreDeleteDoc;
      const doc = window.firestoreDoc;
      
      // Delete from Firestore bookings collection
      await deleteDoc(doc(db, "bookings", session.id));
      
      // Remove from local array
      allSessions = allSessions.filter(s => s.id !== session.id);
      
      // Refresh display
      displaySessions();
      
      alert('Session cancelled successfully!');
    } catch (err) {
      console.error("Error removing session:", err);
      alert('Failed to cancel session. Please try again or contact support.');
    }
  }

  }); // End waitForFirebase promise

</script>
</body>
</html>
