<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Sessions – Amit Tutoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .sessions-container {
      display: grid;
      gap: 2rem;
      margin-top: 1.5rem;
    }
    .session-section h3 {
      margin-bottom: 1rem;
      color: var(--accent);
    }
    .sessions-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .sessions-table th,
    .sessions-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .sessions-table th {
      background: var(--surface-alt);
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .sessions-table tr:last-child td {
      border-bottom: none;
    }
    .sessions-table tr:hover {
      background: var(--surface-alt);
    }
    .session-actions {
      display: flex;
      gap: 0.5rem;
    }
    .session-actions button {
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
    }
    .session-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    .status-past {
      background: #e5e7eb;
      color: #374151;
    }
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    .status-approved {
      background: #d1fae5;
      color: #065f46;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
    }
    .notes-preview {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <h1 class="logo"><a href="index.html">Amit Tutoring</a></h1>

    <nav>
      <a href="dashboard.html">My Dashboard</a>
      <a href="sessions.html" class="active">Sessions</a>
      <a href="book-session.html">Book Session</a>
    </nav>

    <div class="header-right">
      <label class="theme-switch" title="Toggle light/dark mode">
        <input type="checkbox" id="theme-toggle" aria-label="Toggle theme">
        <span class="switch-slider"></span>
      </label>
      <div id="current-time" class="current-time"></div>
    </div>
  </div>
</header>

<main class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <div>
      <h2 style="margin: 0;">My Sessions</h2>
      <p style="margin: 0.5rem 0 0 0;">View all your past and upcoming tutoring sessions.</p>
    </div>
    <button class="btn primary" onclick="window.location.href='book-session.html'">Book Session</button>
  </div>

  <div class="sessions-container">
    <!-- Pending Sessions -->
    <div class="session-section">
      <h3>Pending Sessions</h3>
      <div id="pending-sessions-content">
        <p class="loading-text">Loading pending sessions...</p>
      </div>
    </div>

    <!-- Upcoming Sessions -->
    <div class="session-section">
      <h3>Upcoming Sessions</h3>
      <div id="upcoming-sessions-content">
        <p class="loading-text">Loading upcoming sessions...</p>
      </div>
    </div>

    <!-- Past Sessions -->
    <div class="session-section">
      <h3>Past Sessions</h3>
      <div id="past-sessions-content">
        <p class="loading-text">Loading past sessions...</p>
      </div>
    </div>
  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <p>
      © <span id="year"></span> Amit Tutoring ·
      <a href="contact.html">Contact me</a>
    </p>
  </div>
  <script src="main.js"></script>
</footer>

<!-- Firebase init -->
<script type="module" src="firebase.js"></script>

<!-- Sessions logic -->
<script type="module">
  const auth = window.firebaseAuth;
  const db = window.firebaseDb;
  const onAuth = window.firebaseOnAuth;
  const getDocs = window.firestoreGetDocs;
  const collection = window.firestoreCollection;
  const query = window.firestoreQuery;
  const where = window.firestoreWhere;
  const orderBy = window.firestoreOrderBy;

  let currentUser = null;
  let allSessions = [];

  // Check authentication
  onAuth(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
    await loadSessions();
  });

  async function loadSessions() {
    try {
      // In a real implementation, you'd fetch bookings from Firestore
      // For now, we'll create a structure for when bookings are stored
      const bookingsQuery = query(
        collection(db, "bookings"),
        where("userId", "==", currentUser.uid),
        orderBy("sessionDate", "desc")
      );
      
      const querySnapshot = await getDocs(bookingsQuery);
      allSessions = [];
      
      querySnapshot.forEach((doc) => {
        allSessions.push({ id: doc.id, ...doc.data() });
      });

      displaySessions();
    } catch (err) {
      console.error("Error loading sessions:", err);
      
      // If bookings collection doesn't exist yet, show empty state
      if (err.code === 'permission-denied' || err.message.includes('indexes')) {
        displaySessions(); // Will show empty state
      } else {
        document.getElementById("pending-sessions-content").innerHTML = 
          '<p class="empty-state">Error loading sessions. Please try again later.</p>';
        document.getElementById("upcoming-sessions-content").innerHTML = 
          '<p class="empty-state">Error loading sessions. Please try again later.</p>';
        document.getElementById("past-sessions-content").innerHTML = 
          '<p class="empty-state">Error loading sessions. Please try again later.</p>';
      }
    }
  }

  function displaySessions() {
    const now = new Date();
    const pending = allSessions.filter(s => s.status === 'pending');
    const upcoming = allSessions.filter(s => {
      const sessionDate = s.sessionDate?.toDate ? s.sessionDate.toDate() : new Date(s.sessionDate);
      return sessionDate >= now && s.status === 'approved';
    });
    
    const past = allSessions.filter(s => {
      const sessionDate = s.sessionDate?.toDate ? s.sessionDate.toDate() : new Date(s.sessionDate);
      return sessionDate < now;
    });

    // Display pending sessions
    const pendingContent = document.getElementById("pending-sessions-content");
    if (pending.length === 0) {
      pendingContent.innerHTML = '<div class="empty-state">No pending sessions.</div>';
    } else {
      pendingContent.innerHTML = `
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Students</th>
              <th>Subject</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${pending.map(session => renderPendingSessionRow(session)).join('')}
          </tbody>
        </table>
      `;

      // Add event listeners for approve/decline buttons
      pending.forEach(session => {
        const approveBtn = document.getElementById(`approve-${session.id}`);
        const declineBtn = document.getElementById(`decline-${session.id}`);
        
        if (approveBtn) {
          approveBtn.addEventListener('click', () => approveSession(session));
        }
        if (declineBtn) {
          declineBtn.addEventListener('click', () => declineSession(session));
        }
      });
    }

    // Display upcoming sessions
    const upcomingContent = document.getElementById("upcoming-sessions-content");
    if (upcoming.length === 0) {
      upcomingContent.innerHTML = '<div class="empty-state">No upcoming sessions scheduled.</div>';
    } else {
      upcomingContent.innerHTML = `
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Students</th>
              <th>Subject</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${upcoming.map(session => renderSessionRow(session, true)).join('')}
          </tbody>
        </table>
      `;

      // Add event listeners for edit/remove buttons
      upcoming.forEach(session => {
        const editBtn = document.getElementById(`edit-${session.id}`);
        const removeBtn = document.getElementById(`remove-${session.id}`);
        
        if (editBtn) {
          editBtn.addEventListener('click', () => editSession(session));
        }
        if (removeBtn) {
          removeBtn.addEventListener('click', () => removeSession(session));
        }
      });
    }

    // Display past sessions
    const pastContent = document.getElementById("past-sessions-content");
    if (past.length === 0) {
      pastContent.innerHTML = '<div class="empty-state">No past sessions yet.</div>';
    } else {
      pastContent.innerHTML = `
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Students</th>
              <th>Subject</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            ${past.map(session => renderSessionRow(session, false)).join('')}
          </tbody>
        </table>
      `;
    }
  }

  function renderPendingSessionRow(session) {
    const sessionDate = session.sessionDate?.toDate ? session.sessionDate.toDate() : new Date(session.sessionDate);
    const dateStr = sessionDate.toLocaleDateString('en-US', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
    const timeStr = `${session.startTime} - ${session.endTime || 'TBD'}`;
    const students = session.studentNames || 'N/A';
    const subject = session.subject || 'N/A';

    return `
      <tr>
        <td>${dateStr}</td>
        <td>${timeStr}</td>
        <td>${students}</td>
        <td>${subject}</td>
        <td><span class="session-status status-pending">Pending</span></td>
        <td class="session-actions">
          <button id="approve-${session.id}" class="btn primary">Approve</button>
          <button id="decline-${session.id}" class="btn tertiary">Decline</button>
        </td>
      </tr>
    `;
  }

  function renderSessionRow(session, isUpcoming) {
    const sessionDate = session.sessionDate?.toDate ? session.sessionDate.toDate() : new Date(session.sessionDate);
    const dateStr = sessionDate.toLocaleDateString('en-US', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
    const timeStr = `${session.startTime} - ${session.endTime || 'TBD'}`;
    const students = session.studentNames || 'N/A';
    const subject = session.subject || 'N/A';
    const status = session.status || 'pending';
    const notes = session.tutorNotes || '';

    if (isUpcoming) {
      return `
        <tr>
          <td>${dateStr}</td>
          <td>${timeStr}</td>
          <td>${students}</td>
          <td>${subject}</td>
          <td><span class="session-status status-${status}">${status}</span></td>
          <td class="session-actions">
            <button id="edit-${session.id}" class="btn tertiary">Edit</button>
            <button id="remove-${session.id}" class="btn tertiary">Remove</button>
          </td>
        </tr>
      `;
    } else {
      return `
        <tr>
          <td>${dateStr}</td>
          <td>${timeStr}</td>
          <td>${students}</td>
          <td>${subject}</td>
          <td class="notes-preview" title="${notes}">${notes || 'No notes'}</td>
        </tr>
      `;
    }
  }

  function editSession(session) {
    // Redirect to an edit page with session ID
    window.location.href = `edit-session.html?id=${session.id}`;
  }

  async function removeSession(session) {
    if (!confirm(`Are you sure you want to remove the session on ${new Date(session.sessionDate).toLocaleDateString()}?`)) {
      return;
    }

    try {
      // In a real implementation, you'd delete from Firestore
      // For now, just show a message
      alert('Session removal will be implemented when integrated with your backend.');
      // await deleteDoc(doc(db, "bookings", session.id));
      // await loadSessions(); // Reload after deletion
    } catch (err) {
      console.error("Error removing session:", err);
      alert('Failed to remove session. Please try again.');
    }
  }

  async function approveSession(session) {
    if (!confirm(`Approve session on ${new Date(session.sessionDate).toLocaleDateString()}?`)) {
      return;
    }

    try {
      // In a real implementation, you'd update the status in Firestore
      // For now, just show a message
      alert('Session approval will be implemented when integrated with your backend.');
      // await updateDoc(doc(db, "bookings", session.id), { status: 'approved' });
      // await loadSessions(); // Reload after update
    } catch (err) {
      console.error("Error approving session:", err);
      alert('Failed to approve session. Please try again.');
    }
  }

  async function declineSession(session) {
    if (!confirm(`Decline session on ${new Date(session.sessionDate).toLocaleDateString()}?`)) {
      return;
    }

    try {
      // In a real implementation, you'd either delete or update status to 'declined'
      // For now, just show a message
      alert('Session decline will be implemented when integrated with your backend.');
      // await deleteDoc(doc(db, "bookings", session.id));
      // OR: await updateDoc(doc(db, "bookings", session.id), { status: 'declined' });
      // await loadSessions(); // Reload after update
    } catch (err) {
      console.error("Error declining session:", err);
      alert('Failed to decline session. Please try again.');
    }
  }

</script>
</body>
</html>
