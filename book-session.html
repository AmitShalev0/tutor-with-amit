<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book a Session – Amit Tutoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body data-no-auto-init="true" data-page-id="book-session">
  <!-- <header> -->
    <div id="site-header"></div>
    <script src="header-loader.js"></script>
  <!-- </header> -->

<main class="container">
  <h2 data-editable-block="heroTitle">Book a Tutoring Session</h2>
  <p data-editable-block="introBlurb">
    If your <a href="edit-profile.html">email notification</a> is on, then
    you'll get a confirmation by email after I approve the request.
  </p>

  <form id="booking-form" class="card">
    <div class="students-grid">
      <div class="field-row">
        <label>Student 1 (Primary)*</label>
        <select name="student_1" id="student-1" title="Primary student for this session" required>
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 2</label>
        <select name="student_2" id="student-2" title="Optional second student">
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 3</label>
        <select name="student_3" id="student-3" title="Optional third student">
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 4</label>
        <select name="student_4" id="student-4" title="Optional fourth student">
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 5</label>
        <select name="student_5" id="student-5" title="Optional fifth student">
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 6</label>
        <select name="student_6" id="student-6" title="Optional sixth student">
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 7</label>
        <select name="student_7" id="student-7" title="Optional seventh student">
          <option value="">Select student...</option>
        </select>
      </div>

      <div class="field-row">
        <label>Student 8</label>
        <select name="student_8" id="student-8" title="Optional eighth student">
          <option value="">Select student...</option>
        </select>
      </div>
    </div>

    <div class="field-row tight-space">
      <p class="help-text no-margin" data-editable-block="addStudentHelp">
        Don't see your student? <a href="add-student.html" class="link-inline">Add a new student</a>
      </p>
    </div>

    <div class="field-row">
      <label>Subject for this session*</label>
      <input type="text" name="subject" id="subject" placeholder="e.g. Math 7, Physics 30, Chemistry 30 IB..." required />
    </div>

    <div class="field-row">
      <label>Choose a time from the availability calendar*</label>
      <p class="help-text" data-editable-block="calendarHelp">
        Choose a timeslot (at least 1 hour) by clicking on a block of time on the calendar or using the dropdowns below.
      </p>
      <div class="week-nav">
        <button type="button" id="prev-week" class="btn tertiary week-nav-btn">← Previous Week</button>
        <span id="week-display" class="week-display">Week of ...</span>
        <button type="button" id="next-week" class="btn tertiary week-nav-btn">Next Week →</button>
      </div>
      <div id="availability-calendar" class="availability-calendar">
        <!-- Filled by JS -->
      </div>
      <input type="hidden" name="selected_date" id="selected-date" />
      <input type="hidden" name="selected_start" id="selected-start" />
    </div>

    <div class="field-row time-grid">
      <div>
        <label>Day*</label>
        <select name="day_of_week" id="day-select" title="Day of Week" class="pointer-cursor" required>
          <option value="">Select day…</option>
          <option value="0">Monday</option>
          <option value="1">Tuesday</option>
          <option value="2">Wednesday</option>
          <option value="3">Thursday</option>
          <option value="4">Friday</option>
          <option value="6">Sunday</option>
        </select>
      </div>
      <div>
        <label>Start Time*</label>
        <select name="start_time" id="start-time-input" title="Start Time" class="pointer-cursor" required>
          <option value="">Select start time…</option>
        </select>
      </div>
      <div>
        <label>End Time*</label>
        <select name="duration_hours" id="duration-hours" title="End Time" required>
          <option value="">Select end time…</option>
        </select>
      </div>
    </div>

    <div class="field-row checkbox-row">
      <label>
        <input type="checkbox" id="recurring" name="recurring" title="Make this a weekly recurring session" />
        Make this a weekly recurring session
      </label>
    </div>

    <div class="field-row hidden" id="recurring-end-row">
      <label>Last date for recurring sessions (YYYY-MM-DD)*</label>
      <select name="recurring_end" id="recurring-end" title="Last date for recurring sessions">
        <option value="">Choose last date…</option>
      </select>
    </div>

    <div class="field-row">
      <label>Questions / Comments</label>
      <textarea name="questions" id="questions" rows="4" title="Questions / Comments"></textarea>
    </div>

    <div class="field-row checkbox-row">
      <label>
        <input type="checkbox" id="sliding-scale-toggle" name="sliding_scale_toggle" title="Apply sliding scale discount" />
        Apply sliding scale
      </label>
    </div>

    <div class="field-row hidden sliding-scale-container" id="sliding-scale-row">
      <label for="income-slider">Adjust Discount</label>
      <div class="slider-row">
        <span class="slider-label">Standard Rate</span>
        <input type="range" id="income-slider" class="slider-input" min="0" max="10" value="0" step="1" />
        <span class="slider-label">Maximum Discount</span>
      </div>
      <div class="discount-display">
        Discount: $<span id="discount-amount">0</span> off
      </div>
    </div>

    <div class="cost-row">
      <div id="cost-display" class="cost-display">
        Total Cost: $50.00 per session
      </div>
      <button type="submit" class="btn primary">Submit Booking Request</button>
    </div>

    <p id="booking-form-message" class="form-message"></p>
  </form>
</main>

<footer class="site-footer">
  <div class="container">
    <p>
      © <span id="year"></span> Amit Tutoring ·
      <a href="contact.html">Contact me</a>
    </p>
  </div>
  <script src="core.js" defer></script>
  <script src="booking.js" defer></script>
</footer>

<!-- Firebase init -->
<script type="module" src="firebase-config.js"></script>

<!-- Booking logic -->
<script type="module">
  const auth = window.firebaseAuth;
  const db = window.firebaseDb;
  const onAuth = window.firebaseOnAuth;
  const getDocs = window.firestoreGetDocs;
  const getDoc = window.firestoreGetDoc;
  const collection = window.firestoreCollection;
  const doc = window.firestoreDoc;
  const query = window.firestoreQuery;
  const where = window.firestoreWhere;

  const SITE_SETTINGS_COLLECTION = "siteSettings";
  const BOOKING_SETTINGS_DOC_ID = "booking";
  let bookingFormInitialized = false;

  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKXmxMroW74nabysGBr4LDFhwkURxaBiDntFVnowpP5PN-Czy6cWYnfO5axE58x5_j/exec";

  let currentUser = null;
  let userProfile = null;
  let userStudents = [];
  const STUDENT_DROPDOWN_IDS = [
    "student-1",
    "student-2",
    "student-3",
    "student-4",
    "student-5",
    "student-6",
    "student-7",
    "student-8"
  ];
  let studentDropdowns = [];
  const urlParams = new URLSearchParams(window.location.search);
  const suggestedSubject = urlParams.get('subject');
  const suggestedTutorName = urlParams.get('tutor');

  const TUTOR_DIRECTORY_COLLECTION = 'tutors';
  const DEFAULT_TUTOR_DOC_ID = 'fUXnvGI024fYp4w1AvKUcbM7p8z2';
  let tutorDirectoryCache = null;
  let tutorDirectoryPromise = null;

  function normalizeLookupValue(value) {
    if (value == null) {
      return null;
    }
    const text = typeof value === 'string' ? value.trim() : String(value).trim();
    return text ? text.toLowerCase() : null;
  }

  function pickFirstValidId(values) {
    if (!Array.isArray(values)) {
      return null;
    }
    for (const value of values) {
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (trimmed) {
          return trimmed;
        }
      }
    }
    return null;
  }

  async function loadTutorDirectory() {
    if (tutorDirectoryCache) {
      return tutorDirectoryCache;
    }
    if (!tutorDirectoryPromise) {
      tutorDirectoryPromise = (async () => {
        if (!db || !collection || !getDocs) {
          return [];
        }
        try {
          const snapshot = await getDocs(collection(db, TUTOR_DIRECTORY_COLLECTION));
          tutorDirectoryCache = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            data: docSnap.data() || {}
          }));
        } catch (error) {
          console.warn('Unable to load tutors directory', error);
          tutorDirectoryCache = [];
        }
        return tutorDirectoryCache;
      })();
    }
    return tutorDirectoryPromise;
  }

  function matchByCandidate(fields, needle) {
    if (!needle || !Array.isArray(fields)) {
      return false;
    }
    return fields.some((candidate) => normalizeLookupValue(candidate) === needle);
  }

  function resolveConfiguredTutorDocId({ bookingSettings, userProfile, directory }) {
    const configured = pickFirstValidId([
      bookingSettings?.defaultTutorDocId,
      bookingSettings?.primaryTutorDocId,
      bookingSettings?.tutorDocId,
      bookingSettings?.defaultTutorRecordId,
      bookingSettings?.primaryTutorRecordId,
      bookingSettings?.tutorRecordId,
      userProfile?.preferredTutorDocId,
      userProfile?.preferredTutorRecordId,
      userProfile?.tutorDocId
    ]);
    if (!configured) {
      return null;
    }
    const configuredNorm = normalizeLookupValue(configured);
    if (!configuredNorm || !Array.isArray(directory) || !directory.length) {
      return configured;
    }
    const matchingEntry = directory.find((entry) => normalizeLookupValue(entry.id) === configuredNorm);
    return matchingEntry ? matchingEntry.id : configured;
  }

  async function resolveTutorDocumentId({ tutorUid, tutorName, bookingSettings = {}, userProfile = null }) {
    const directory = await loadTutorDirectory();
    const uidNorm = normalizeLookupValue(tutorUid);
    if (uidNorm && uidNorm !== 'unassigned') {
      const directMatch = Array.isArray(directory)
        ? directory.find((entry) => normalizeLookupValue(entry.id) === uidNorm)
        : null;
      if (directMatch) {
        return directMatch.id;
      }
      const relatedMatch = Array.isArray(directory)
        ? directory.find((entry) => {
            const data = entry.data || {};
            const candidates = [
              data.uid,
              data.userId,
              data.userID,
              data.tutorUid,
              data.tutorID,
              data.ownerUid,
              data.ownerId,
              data.profile?.uid,
              data.profile?.userId,
              data.profile?.ownerUid,
              data.profile?.userID
            ];
            return matchByCandidate(candidates, uidNorm);
          })
        : null;
      if (relatedMatch) {
        return relatedMatch.id;
      }
    }

    const nameNorm = normalizeLookupValue(tutorName);
    if (nameNorm) {
      const nameMatch = Array.isArray(directory)
        ? directory.find((entry) => {
            const data = entry.data || {};
            const candidates = [
              data.fullName,
              data.displayName,
              data.legalName,
              data.preferredName,
              data.name,
              data.profile?.fullName,
              data.profile?.displayName,
              data.billing?.legalName
            ];
            return matchByCandidate(candidates, nameNorm);
          })
        : null;
      if (nameMatch) {
        return nameMatch.id;
      }
    }

    const configuredDocId = resolveConfiguredTutorDocId({ bookingSettings, userProfile, directory });
    if (configuredDocId) {
      return configuredDocId;
    }

    if (Array.isArray(directory) && directory.length === 1) {
      return directory[0].id;
    }

    if (uidNorm && uidNorm !== 'unassigned') {
      return tutorUid;
    }

    const fallback = bookingSettings?.defaultTutorUid
      || bookingSettings?.primaryTutorUid
      || userProfile?.preferredTutorUid
      || DEFAULT_TUTOR_DOC_ID;
    return fallback;
  }

  function cacheStudentDropdowns() {
    studentDropdowns = STUDENT_DROPDOWN_IDS.map((id) => document.getElementById(id));
    window.bookingStudentDropdowns = studentDropdowns;
  }

  function handleStudentSelectionChange() {
    if (typeof window.recalculateBookingCost === 'function') {
      window.recalculateBookingCost();
    }
  }

  function attachStudentDropdownListeners() {
    studentDropdowns.forEach((dropdown) => {
      if (!dropdown) return;
      dropdown.addEventListener('change', handleStudentSelectionChange);
    });
  }

  function getConfiguredStudentLimit(settings) {
    const fallbackMax = (typeof DEFAULT_BOOKING_SETTINGS !== 'undefined'
      ? DEFAULT_BOOKING_SETTINGS.maxStudentsPerSession
      : STUDENT_DROPDOWN_IDS.length);
    const raw = Number(settings?.maxStudentsPerSession ?? fallbackMax);
    const parsed = Number.isFinite(raw) ? raw : fallbackMax;
    return Math.min(Math.max(Math.round(parsed) || 1, 1), STUDENT_DROPDOWN_IDS.length);
  }

  function applyBookingSettingsToStudentSelectors(settings) {
    const limit = getConfiguredStudentLimit(settings || window.bookingSettings || {});
    studentDropdowns.forEach((dropdown, index) => {
      if (!dropdown) return;
      const container = dropdown.closest('.field-row');
      const withinLimit = index < limit;
      if (withinLimit) {
        dropdown.disabled = false;
        if (container) {
          container.classList.remove('hidden');
        }
      } else {
        dropdown.value = '';
        dropdown.disabled = true;
        if (container) {
          container.classList.add('hidden');
        }
      }
    });
    handleStudentSelectionChange();
  }

  window.getBookingStudentCount = () => {
    let count = 0;
    studentDropdowns.forEach((dropdown) => {
      if (!dropdown || dropdown.disabled) {
        return;
      }
      const container = dropdown.closest('.field-row');
      if (container && container.classList.contains('hidden')) {
        return;
      }
      if (dropdown.value) {
        count += 1;
      }
    });
    return count;
  };

  cacheStudentDropdowns();
  attachStudentDropdownListeners();

  if (suggestedSubject) {
    const subjectInput = document.getElementById("subject");
    if (subjectInput && !subjectInput.value) {
      subjectInput.value = suggestedSubject;
    }
  }

  // Check authentication
  onAuth(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    
    // Wait a moment for Firebase to fully initialize
    await new Promise(resolve => setTimeout(resolve, 100));
    
    currentUser = user;
    await loadUserData();
  });

  async function loadBookingSettingsFromFirestore() {
    if (!db) {
      return null;
    }
    try {
      const settingsSnapshot = await getDoc(doc(db, SITE_SETTINGS_COLLECTION, BOOKING_SETTINGS_DOC_ID));
      if (settingsSnapshot?.exists()) {
        const data = settingsSnapshot.data();
        console.log("Loaded booking settings:", data);
        window.bookingSettings = data;
        return data;
      }
    } catch (error) {
      console.warn("Unable to fetch booking settings:", error);
    }
    return null;
  }

  async function loadUserData() {
    try {
      // Verify db is initialized
      if (!db) {
        console.error("Firestore database not initialized!");
        throw new Error("Database connection not available. Please refresh the page.");
      }
      
      console.log("Loading user data for:", currentUser.uid);
      const bookingSettingsPromise = loadBookingSettingsFromFirestore();
      
      // Load user profile
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      if (userDoc.exists()) {
        userProfile = userDoc.data();
        console.log("User profile loaded:", userProfile);
        
        // Check sliding scale eligibility
        checkSlidingScaleEligibility();
      } else {
        console.warn("User profile not found in Firestore");
      }

      // Load students
      console.log("Loading students...");
      const studentsQuery = query(
        collection(db, "students"),
        where("userId", "==", currentUser.uid)
      );
      const querySnapshot = await getDocs(studentsQuery);
      
      userStudents = [];
      querySnapshot.forEach((doc) => {
        userStudents.push({ id: doc.id, ...doc.data() });
      });
      
      console.log("Students loaded:", userStudents.length);

      displayStudentDropdowns();

      if (typeof setupBookingForm === 'function') {
        const fetchedSettings = await bookingSettingsPromise;
        setupBookingForm(fetchedSettings || {});
        bookingFormInitialized = true;
        applyBookingSettingsToStudentSelectors(window.bookingSettings);
      } else {
        applyBookingSettingsToStudentSelectors(window.bookingSettings);
      }

    } catch (err) {
      console.error("Error loading user data:", err);
      if (!bookingFormInitialized && typeof setupBookingForm === 'function') {
        setupBookingForm();
        bookingFormInitialized = true;
        applyBookingSettingsToStudentSelectors(window.bookingSettings);
      }
      alert("Error loading your data: " + err.message + ". Please refresh the page.");
    }
  }
  
  function checkSlidingScaleEligibility() {
    // Check if user has sliding scale eligibility enabled
    const slidingScaleCheckbox = document.getElementById("sliding-scale-toggle");
    const slidingScaleLabel = slidingScaleCheckbox?.parentElement;
    
    if (!slidingScaleCheckbox) return;
    
    // Check if user has sliding_scale_eligible field (stored in Firestore users collection)
    const isEligible = userProfile?.slidingScaleEligible === true;
    
    if (!isEligible) {
      // Disable the checkbox and show why
      slidingScaleCheckbox.disabled = true;
      slidingScaleCheckbox.checked = false;
      
      if (slidingScaleLabel) {
        slidingScaleLabel.style.opacity = "0.5";
        slidingScaleLabel.style.cursor = "not-allowed";
        slidingScaleLabel.title = "Sliding scale discount is not available for your account. Please contact the tutor if you need assistance.";
      }
      
      // Hide the slider if it was visible
      const slidingScaleRow = document.getElementById("sliding-scale-row");
      if (slidingScaleRow) {
        slidingScaleRow.classList.add("hidden");
      }
    } else {
      // Enable the checkbox
      slidingScaleCheckbox.disabled = false;
      if (slidingScaleLabel) {
        slidingScaleLabel.style.opacity = "1";
        slidingScaleLabel.style.cursor = "pointer";
        slidingScaleLabel.title = "Apply sliding scale discount";
      }
    }
  }

  function displayStudentDropdowns() {
    cacheStudentDropdowns();

    if (userStudents.length === 0) {
      // Show message and disable first dropdown
      const firstDropdown = studentDropdowns[0];
      if (firstDropdown) {
        firstDropdown.innerHTML = '<option value="">No students added yet</option>';
        firstDropdown.disabled = true;
      }
      applyBookingSettingsToStudentSelectors(window.bookingSettings);
      return;
    }

    // Populate each dropdown with user's students
    studentDropdowns.forEach((dropdown) => {
      if (!dropdown) {
        return;
      }
      const placeholder = dropdown.querySelector('option[value=""]');
      dropdown.innerHTML = '';
      if (placeholder) {
        dropdown.appendChild(placeholder);
      } else {
        const fallbackOption = document.createElement('option');
        fallbackOption.value = '';
        fallbackOption.textContent = 'Select student...';
        dropdown.appendChild(fallbackOption);
      }

      userStudents.forEach((student) => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.studentName;
        dropdown.appendChild(option);
      });
    });
    
    if (window.bookingSettings) {
      applyBookingSettingsToStudentSelectors(window.bookingSettings);
    }
    handleStudentSelectionChange();
    
    // Add change event listener to Student 1 (Primary) to auto-populate subject
    const primaryStudentDropdown = studentDropdowns[0];
    const subjectInput = document.getElementById("subject");
    
    if (primaryStudentDropdown && subjectInput) {
      primaryStudentDropdown.addEventListener('change', (e) => {
        const selectedStudentId = e.target.value;
        if (selectedStudentId) {
          const student = userStudents.find(s => s.id === selectedStudentId);
          if (student && student.subject) {
            subjectInput.value = student.subject;
          }
        }
      });
    }
  }

  // Initialize booking form (reuse existing main.js logic)
  // The form will be populated with user's email, phone, and name automatically
  let isSubmitting = false; // Prevent double submissions
  
  document.getElementById("booking-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Prevent double submission
    if (isSubmitting) {
      console.log("Form already submitting, ignoring duplicate submission");
      return;
    }
    
    isSubmitting = true;
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = "Submitting...";
    
    const msg = document.getElementById("booking-form-message");
    msg.textContent = "Submitting booking request…";
    msg.className = "form-message";

    // Get selected students from dropdowns
    const selectedStudents = [];
    
    studentDropdowns.forEach((dropdown) => {
      if (!dropdown || dropdown.disabled || !dropdown.value) {
        return;
      }
      const container = dropdown.closest('.field-row');
      if (container && container.classList.contains('hidden')) {
        return;
      }
      const student = userStudents.find((s) => s.id === dropdown.value);
      if (student) {
        selectedStudents.push(student.studentName);
      }
    });

    if (selectedStudents.length === 0) {
      msg.textContent = "Please select at least one student.";
      msg.classList.add("error");
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
      isSubmitting = false;
      return;
    }

    const formData = new FormData(e.target);
    const obj = Object.fromEntries(formData.entries());
    obj.type = "booking_request";

    if (suggestedTutorName) {
      obj.preferred_tutor = suggestedTutorName;
    }
    
    // Add user profile data with fallbacks
    obj.guardian_full_name = (userProfile && userProfile.fullName) || "Guest User";
    obj.email = (userProfile && userProfile.email) || currentUser.email || "";
    obj.phone = (userProfile && userProfile.phone) || "";
    
    obj.num_students = selectedStudents.length;
    obj.student_names = selectedStudents.join(", ");
    obj.session_title = `${obj.subject} – ${selectedStudents.join(", ")}`;
    if (suggestedTutorName) {
      obj.session_title += ` (Requested tutor: ${suggestedTutorName})`;
    }
    
    // Frontend validation: Check required fields before submitting
    const requiredFields = {
      'Subject': obj.subject,
      'Email': obj.email,
      'Name': obj.guardian_full_name,
      'Date': obj.selected_date,
      'Start Time': obj.selected_start,
      'Students': obj.student_names
    };
    
    const missingFields = [];
    for (const [fieldName, value] of Object.entries(requiredFields)) {
      if (!value || value === "" || value === "Guest User" || value === "0") {
        missingFields.push(fieldName);
      }
    }
    
    if (missingFields.length > 0) {
      msg.textContent = `Please fill in all required fields: ${missingFields.join(", ")}`;
      msg.classList.add("error");
      msg.classList.remove("ok");
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
      isSubmitting = false;
      return;
    }

    // Calculate final cost
    const duration = parseFloat(obj.duration_hours || "1");
    const slidingScaleEnabled = obj.sliding_scale_toggle === "on";
    const discountSlider = document.getElementById("income-slider");
    
    const fallbackSettings = (typeof DEFAULT_BOOKING_SETTINGS !== 'undefined')
      ? DEFAULT_BOOKING_SETTINGS
      : { baseSessionCost: 50, extraStudentCost: 20 };
    const activeSettings = window.bookingSettings || fallbackSettings;
    const baseRate = Number(activeSettings.baseSessionCost) || fallbackSettings.baseSessionCost;
    const additionalRate = Number(activeSettings.extraStudentCost) || fallbackSettings.extraStudentCost;
    const costPerHour = baseRate + ((selectedStudents.length - 1) * additionalRate);
    const standardTotal = (costPerHour * duration);
    
    let finalCost = standardTotal;
    if (slidingScaleEnabled && discountSlider) {
      const discountSteps = parseInt(discountSlider.value);
      const discountPerHour = discountSteps * 10;
      const discountAmount = discountPerHour * duration;
      finalCost = standardTotal - discountAmount;
    }

    if (finalCost < 0) {
      finalCost = 0;
    }

    const roundedFinalCost = Math.round(finalCost * 100) / 100;
    const amountCents = Math.round(roundedFinalCost * 100);
    obj.final_cost = roundedFinalCost.toFixed(2);
    obj.amount_cents = amountCents;
    obj.currency = 'cad';

    // Debug: Log what we're sending
    console.log("Booking data being sent:", obj);
    console.log("User profile:", userProfile);
    console.log("Selected students:", selectedStudents);

    try {
      // FIRST: Save to Firestore as PENDING booking (shows on user's sessions page immediately)
      
      // Calculate end time from start time + duration
      const startTime = obj.selected_start; // e.g., "09:15"
      const durationHours = parseFloat(obj.duration_hours || "1");
      
      // Parse start time and add duration
      const [startHour, startMinute] = startTime.split(':').map(Number);
      const startDate = new Date();
      startDate.setHours(startHour, startMinute, 0, 0);
      
      const endDate = new Date(startDate.getTime() + (durationHours * 60 * 60 * 1000));
      const endTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
      
      const resolveTutorUid = () => {
        const settings = window.bookingSettings || {};
        const candidate = settings.defaultTutorUid
          || settings.primaryTutorUid
          || settings.tutorUid
          || settings.defaultTutorId
          || settings.primaryTutorId
          || settings.tutorId;
        if (candidate) {
          return candidate;
        }
        if (userProfile?.preferredTutorUid) {
          return userProfile.preferredTutorUid;
        }
        return 'unassigned';
      };

      const tutorUid = resolveTutorUid();
      const resolvedTutorDocId = await resolveTutorDocumentId({
        tutorUid,
        tutorName: suggestedTutorName || userProfile?.preferredTutorName || userProfile?.preferredTutor,
        bookingSettings: window.bookingSettings || {},
        userProfile
      });
      const tutorDocId = (typeof resolvedTutorDocId === 'string' && resolvedTutorDocId.trim())
        ? resolvedTutorDocId.trim()
        : (tutorUid && tutorUid !== 'unassigned' ? tutorUid : DEFAULT_TUTOR_DOC_ID);

      // Base booking data
      const baseBookingData = {
        userId: currentUser.uid,
        userID: currentUser.uid,
        tutorId: tutorUid,
        tutorUid,
        tutorID: tutorDocId,
        studentNames: obj.student_names,
        students: obj.student_names,
        studentName: obj.student_names,  // Add this for consistency
        subject: obj.subject,
        startTime: startTime,
        endTime: endTime,
        duration: durationHours,
        durationHours: durationHours,
        status: "pending_payment",
        comments: obj.questions || "",
        notes: obj.questions || "",
        additionalComments: obj.questions || "",
        guardianEmail: userProfile?.email || currentUser.email,
        guardianPhone: userProfile?.phone || "",
        guardianName: userProfile?.fullName || currentUser.displayName || "",
        createdAt: new Date().toISOString(),
        source: "WEBSITE_BOOKING_FORM",
        cost: obj.final_cost,
        requestedTutor: suggestedTutorName || null,
        approvalStatus: 'pending',
        currency: 'cad',
        amountCents,
        paymentStatusHistory: [
          {
            status: 'pending_payment',
            changedAt: new Date().toISOString(),
            changedBy: currentUser.uid,
            source: 'web:booking_form'
          }
        ]
      };
      
      // Add to Firestore bookings collection
      const addDoc = window.firestoreAddDoc;
      const collection = window.firestoreCollection;
      
      // Check if recurring
      const isRecurring = obj.recurring === "on";
      let bookingCount = 0; // Declare at outer scope so it's accessible later
      
      if (isRecurring && obj.recurring_end) {
        // Create multiple bookings - one for each week until recurring_end
        // Parse dates correctly in local time (avoid timezone issues)
        const [firstYear, firstMonth, firstDay] = obj.selected_date.split('-').map(Number);
        const firstDate = new Date(firstYear, firstMonth - 1, firstDay);
        
        const [lastYear, lastMonth, lastDay] = obj.recurring_end.split('-').map(Number);
        const lastDate = new Date(lastYear, lastMonth - 1, lastDay);
        
        let currentDate = new Date(firstDate);
        
        while (currentDate <= lastDate) {
          // Format date as YYYY-MM-DD
          const year = currentDate.getFullYear();
          const month = String(currentDate.getMonth() + 1).padStart(2, '0');
          const day = String(currentDate.getDate()).padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;
          
          // Create booking for this date
          const bookingData = {
            ...baseBookingData,
            sessionDate: dateStr,
            isPartOfRecurringSeries: true,
            recurringSeriesStart: obj.selected_date,
            recurringSeriesEnd: obj.recurring_end
          };
          
          const bookingRef = await addDoc(collection(db, "bookings"), bookingData);
          console.log(`Saved recurring booking ${bookingCount + 1} to Firestore with ID:`, bookingRef.id, "for date:", dateStr);
          bookingCount++;
          
          // Move to next week
          currentDate.setDate(currentDate.getDate() + 7);
        }
        
        console.log(`Created ${bookingCount} recurring bookings from ${obj.selected_date} to ${obj.recurring_end}`);
      } else {
        // Single booking
        const bookingData = {
          ...baseBookingData,
          sessionDate: obj.selected_date
        };
        
        const bookingRef = await addDoc(collection(db, "bookings"), bookingData);
        console.log("Saved to Firestore with ID:", bookingRef.id);
        bookingCount = 1; // Single booking
      }
      
      // SECOND: Also send to Google Sheets via Apps Script (for your records)
      // Note: Using no-cors mode means we can't read the response, but submission still works
      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors", // Prevents CORS errors but we can't read response
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(obj),
        });
        console.log("Booking also sent to Google Sheets");
      } catch (sheetsError) {
        console.warn("Google Sheets submission warning (can ignore):", sheetsError);
        // Continue even if sheets fails - Firestore is the main storage
      }

      // Success! Show confirmation message
      const bookingCountMsg = isRecurring && obj.recurring_end 
        ? ` (${bookingCount} session${bookingCount !== 1 ? 's' : ''} from ${obj.selected_date} to ${obj.recurring_end})`
        : "";
      msg.textContent = `Thanks! Your booking request has been submitted${bookingCountMsg}. I will review it and email you with confirmation.`;
      msg.classList.add("ok");
      msg.classList.remove("error");
      
      // Don't call form.reset() or renderStudentFields() after successful submission
      // Just redirect to sessions page after 2 seconds
      setTimeout(() => {
        window.location.href = "sessions.html";  // Redirect to sessions page so they can see their pending booking
      }, 2500);

    } catch (err) {
      console.error("Booking submission error:", err);
      msg.textContent = "Something went wrong. Please try again or contact me directly.";
      msg.classList.add("error");
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
      isSubmitting = false;
    }
  });
</script>

<script type="module" src="page-editor.js"></script>
</body>
</html>
